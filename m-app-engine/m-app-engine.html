<!--
Copyright 2016 SabzCity

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<link rel="import" href="../../paper-toast/paper-toast.html">
<link rel="import" href="../a-public-library/a-public-library.html">

<dom-module id="sabzcity-app-engine">
	<template>
		<iron-ajax auto id="userDistinctionAjax" url="https://apis.sabz.city/usersinfo/v1/123456789123456/distinctions/front-end/"
		    handle-as="json" on-response="_handleResponse">
		</iron-ajax>
	</template>
	<script>
		Polymer({
			is: "sabzcity-app-engine",
			ready: function () {
				//just for test
				if (publicLibrary.cookieManager.get("AU") == false) {
					publicLibrary.cookieManager.set("AU", "Guest", 10)
				}
				//get active user uuid and set distinction
				this.userDistinction(this._handleResponse.downloadedDistictions)
				//Push Language in Url if it isn't exist by user distinction
				this.pushLanguage(activeUser.distinctions.Language)
				//Set App Element
				this.appendApp()
				//Load default or user distinction theme
				this.loadTheme(activeUser.distinctions.Template)
			},
			//response ajax
			_handleResponse: function (e, req) {
				if (e.target.id == "userDistinctionAjax" && req.xhr.status == 200 && req.xhr.readyState == 4) {
					var downloadedDistictions = e.detail.response;
				}
			},
			//get active user uuid from cookie and set distinction
			userDistinction: function (downloadedDistictions) {
				//Set Active UserID globally in activeUser object
				activeUser.ID = publicLibrary.cookieManager.get("AU")
				//Get User Distinction from SabzCity Apis
				//If request response is not 200OK read Distinction from LocalStorage and set it in activeUser Global object
				if (downloadedDistictions == null && publicLibrary.userLocalDistinctions.getAll(activeUser.ID) == true) {
					console.log("not download")
					activeUser.distinctions = publicLibrary.userLocalDistinctions.getAll(activeUser.ID)
				//If Request response 200OK set it in activeUser Global object and LocalStorage
				} else if (!downloadedDistictions == null) {
					activeUser.distinctions = downloadedDistictions
					console.log(downloadedDistictions)
					publicLibrary.userLocalDistinctions.updateAll(activeUser.ID, activeUser.distinctions)
				//If everythings goes wrong just use Default value!
				} else {
					console.log("download goes wrong")
					return
				}
			},
			//Append app elements by suggestion architecture.
			appendApp: function () {
				var appLink = publicLibrary.makeElement("link", {
					"rel": "import",
					"href": publicLibrary.app.location + publicLibrary.app.name + ".html"
				})
				document.head.appendChild(appLink)
				var appElement = publicLibrary.makeElement(publicLibrary.app.name)
				Polymer.dom(this.root).appendChild(appElement)
			},
			//Push Language in Url if it isn't exist by user distinction
			pushLanguage: function (languageName) {
				var langs = ["per", "en", "de"] //supported languages
				var fullpath = window.location.href.replace(window.location.origin, "")
				var parts = fullpath.split('/')

				//if valid language not find in url
				if (parts[1].length == 0 || langs.indexOf(parts[1]) == -1) {
					var urlWithLang = languageName
					if (parts[1].length != 0) {
						urlWithLang = languageName + fullpath
					}
					if (checkForAddingSlash()) {
						urlWithLang = urlWithLang + "/"
					}
					var newUrl = new URL(urlWithLang, window.location.origin)
					history.pushState(window.history.state, "language", newUrl)
					//show notification
					var notification_element = publicLibrary.makeElement("paper-toast", {
						"text": "Hello world!",
						"opened": true
					})
					Polymer.dom(this.root).appendChild(notification_element)
					//if valid language find in url
				} else {
					if (checkForAddingSlash()) {
						var newUrl = new URL(fullpath + "/", window.location.origin)
						history.pushState(window.history.state, "language", newUrl)
					}
				}
				//check url for adding slash
				function checkForAddingSlash() {
					if (fullpath.slice(-1) == "/" && parts[1].length != 0)
						return false;
					else if (parts[parts.length - 1].includes("?") || parts[parts.length - 1].includes("."))
						return false;
					else
						return true;
				}
			},
			//Toast a suggestion if default language is not probebly selected
			suggestLanguage: function () {

			},
			//Append app theme.
			loadTheme: function (themeName) {
				if (themeName == null) {
					themeName = "default"
				}
				var themeLink = publicLibrary.makeElement("link", {
					"rel": "import",
					"href": publicLibrary.app.location + "theme/" + themeName + ".html"
				})
				document.head.appendChild(themeLink)
			}
		});
	</script>
</dom-module>