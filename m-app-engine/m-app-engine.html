<!--
Copyright 2016 SabzCity

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!-- polymer elements -->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<link rel="import" href="../../paper-toast/paper-toast.html">
<!-- app elements -->
<link rel="import" href="../a-public-library/a-public-library.html">

<dom-module id="m-app-engine">
	<template>
		<iron-ajax auto id="userdistinction_ajax" url="https://apis.sabz.city/usersinfo/v1/123456789123458/distinctions/front-end/"
		    handle-as="json" on-response="_handleResponse">
		</iron-ajax>
	</template>
	<script>
		Polymer({
			is: "m-app-engine",
			properties: {
				distinctionReady: {
					type: Boolean,
					value: false
				}
			},
			ready: function () {
				//just for test
				if (publicLibrary.cookieManager.get("AU") == false) {
					publicLibrary.cookieManager.set("AU", "Guest", 10)
				}
				//get active user uuid and set distinction
				this.userDistinction()
				//Set App Element
				this.appendApp()
			},
			//response ajax
			_handleResponse: function (e, req) {
				local = this
				if (req.xhr.status == 200 && req.xhr.readyState == 4) {
					var res = e.detail.response
					//get userdistinction from api
					if (e.target.id == "userdistinction_ajax") {
						console.log(res)
						publicLibrary.userLocalDistinctions.updateAll(activeUser.ID, res)
						activeUser.distinctions = res
						local.distinctionReady = true
					}
				}
			},
			//get active user uuid and set distinction
			userDistinction: function () {
				local = this
				//Set Active UserID globally in activeUser object
				activeUser.ID = publicLibrary.cookieManager.get("AU")
				if (local.distinctionReady == true) {
					local.pushLanguage(activeUser.distinctions.Language)
					local.loadTheme(activeUser.distinctions.Template)
					console.log("sss")
				} else {
					setTimeout(function () {
						if (local.distinctionReady == true || publicLibrary.userLocalDistinctions.getAll(activeUser.ID)) {
							activeUser.distinctions = publicLibrary.userLocalDistinctions.getAll(activeUser.ID)
							local.pushLanguage(activeUser.distinctions.Language)
							local.loadTheme(activeUser.distinctions.Template)
						} else {
							console.log("error")
							return
						}
					}, 500)
				}

			},
			//Append app elements by suggestion architecture.
			appendApp: function () {
				var appLink = publicLibrary.makeElement("link", {
					"rel": "import",
					"href": publicLibrary.app.location + publicLibrary.app.name + ".html"
				})
				document.head.appendChild(appLink)
				var appElement = publicLibrary.makeElement(publicLibrary.app.name)
				Polymer.dom(this.root).appendChild(appElement)
			},
			//Push Language in Url if it isn't exist by user distinction
			pushLanguage: function (languageName) {
				var langs = Object.keys(languagesList) //supported languages
				var fullpath = window.location.href.replace(window.location.origin, "")
				var parts = fullpath.split('/')

				//if valid language not find in url
				if (parts[1].length == 0 || langs.indexOf(parts[1]) == -1) {
					var urlWithLang = languageName
					if (parts[1].length != 0) {
						urlWithLang = languageName + fullpath
					}
					if (checkForAddingSlash()) {
						urlWithLang = urlWithLang + "/"
					}
					var newUrl = new URL(urlWithLang, window.location.origin)
				//if valid language find in url	
				} else {
					if (checkForAddingSlash()) {
						var newUrl = new URL(fullpath + "/", window.location.origin)
						history.pushState(window.history.state, "language", newUrl)
					}
				}
				//check url for adding slash
				function checkForAddingSlash() {
					if (fullpath.slice(-1) == "/" && parts[1].length != 0)
						return false;
					else if (parts[parts.length - 1].includes("?") || parts[parts.length - 1].includes("."))
						return false;
					else
						return true;
				}
			},
			//Toast a suggestion if default language is not probebly selected
			suggestLanguage: function () {
				Polymer.dom(this.root).appendChild(notification_element)
				history.pushState(window.history.state, "language", newUrl)
				//show notification
				var notification_element = publicLibrary.makeElement("paper-toast", {
					"text": "Hello world!",
					"opened": true
				})
			},
			//Append app theme.
			loadTheme: function (themeName) {
				if (themeName == null) {
					themeName = "default"
				}
				var themeLink = publicLibrary.makeElement("link", {
					"rel": "import",
					"href": publicLibrary.app.location + "theme/" + themeName + ".html"
				})
				document.head.appendChild(themeLink)
			}
		});
	</script>
</dom-module>