<!--
Copyright 2016 SabzCity

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!-- polymer elements -->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../paper-toast/paper-toast.html">
<!-- app elements -->
<link rel="import" href="../a-public-library/a-public-library.html">
<link rel="import" href="../../SabzCityWebComponents/sabzcity-sdk/sabzcity-sdk.html">

<dom-module id="m-app-engine">
	<template>
		<sabzcity-sdk version="v1" service="usersinfo" method="GetFrontEndDistinctions" userID="" on-response="_handleResponse"></sabzcity-sdk>
	</template>
	<script>
		Polymer({
			is: "m-app-engine",
			properties: {
				distinctionReady: {
					type: Boolean,
					value: false
				}
			},
			ready: function () {
				//just for test
				if (publicLibrary.cookieManager.get("AU") == false) {
					publicLibrary.cookieManager.set("AU", "Guest", 10)
				}

				//Set Active UserID globally in activeUser object
				activeUser.ID = publicLibrary.cookieManager.get("AU")

				//Check if active user is not Guest get fresh distinction
				if (activeUser.ID != "Guest") {
					//get active user uuid and set distinction
					this.updateUserDistinction()
					//Guess language for Guest User and notice it!
				} else {
					this.suggestLanguage()
				}
				//Set App Element
				this.appendApp()
				//Set Language in url
				this.pushLanguage(activeUser.distinctions.Language)
				//Load related app theme
				this.loadTheme(activeUser.distinctions.Template)
			},
			//response ajax
			_handleResponse: function (e, req) {
				local = this
				if (req.xhr.status == 200 && req.xhr.readyState == 4) {
					var res = e.detail.response
					//get userdistinction from api
					if (e.target.id == "userdistinction_ajax") {
						console.log(res)
						publicLibrary.userLocalDistinctions.updateAll(activeUser.ID, res)
						activeUser.distinctions = res
						local.distinctionReady = true
					}
				}
			},
			//Update active user distinctions
			updateUserDistinction: function () {
				local = this
				//Check SabzCity APIs response deliver
				if (local.distinctionReady == true) {
					return
				} else {
					setTimeout(function () {
						//Wait 300ms to recive response
						if (local.distinctionReady == true) {
							return
							//if download failed load previous distinction
						} else if (publicLibrary.userLocalDistinctions.getAll(activeUser.ID)) {
							activeUser.distinctions = publicLibrary.userLocalDistinctions.getAll(activeUser.ID)
							//if theres no previous distinction in localstorage, load default settings
						} else {
							return
						}
					}, 300)
				}
			},
			//Append app elements by suggestion architecture.
			appendApp: function () {
				var appLink = publicLibrary.makeElement("link", {
					"rel": "import",
					"href": publicLibrary.app.location + publicLibrary.app.name + ".html"
				})
				document.head.appendChild(appLink)
				var appElement = publicLibrary.makeElement(publicLibrary.app.name)
				Polymer.dom(this.root).appendChild(appElement)
			},
			//Push Language in Url if it isn't exist by user distinction
			pushLanguage: function (languageName) {
				var langs = Object.keys(languagesList) //supported languages
				var fullpath = window.location.href.replace(window.location.origin, "")
				var parts = fullpath.split('/')

				//if valid language not find in url
				if (parts[1].length == 0 || langs.indexOf(parts[1]) == -1) {
					var urlWithLang = languageName
					if (parts[1].length != 0) {
						urlWithLang = languageName + fullpath
					}
					if (checkForAddingSlash()) {
						urlWithLang = urlWithLang + "/"
					}
					var newUrl = new URL(urlWithLang, window.location.origin)
					history.pushState(window.history.state, "language", newUrl)
					//if valid language find in url
				} else {
					if (checkForAddingSlash()) {
						var newUrl = new URL(fullpath + "/", window.location.origin)
						history.pushState(window.history.state, "language", newUrl)
					}
				}
				//check url for adding slash
				function checkForAddingSlash() {
					if (fullpath.slice(-1) == "/" && parts[1].length != 0)
						return false;
					else if (parts[parts.length - 1].includes("?") || parts[parts.length - 1].includes("."))
						return false;
					else
						return true;
				}
			},
			//Guess language for Guest User and notice it!
			suggestLanguage: function () {
				//Send request to server and get suggested language by user IP
				var detectedLanguage
				//Wait and if anwser received in 300ms, set it
				setTimeout(function () {
					detectedLanguage = "en"
				}, 300)
				if (detectedLanguage != null) {
					activeUser.distinctions.Language = detectedLanguage
				// set Browser default language
				} else {
					activeUser.distinctions.Language = navigator.language.substr(0, 2)
				}

				//Willy nilly Toast the suggestion and the way user can change language in English
				var notification_element = publicLibrary.makeElement("paper-toast", {
					"text": "We detect this language for you. You can change it anytime from hamberger menu!" + activeUser.distinctions.Language,
					"opened": true
				})
				Polymer.dom(this.root).appendChild(notification_element)
			},
			//Append app theme.
			loadTheme: function (themeName) {
				if (themeName == null) {
					themeName = "default"
				}
				var themeLink = publicLibrary.makeElement("link", {
					"rel": "import",
					"href": publicLibrary.app.location + "themes/" + themeName + ".html"
				})
				document.head.appendChild(themeLink)
			}
		});
	</script>
</dom-module>